<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>架构 | druid 中文网</title>
    <meta name="description" content="Druid是一个专门针对事件数据的OLAP查询而设计的开源数据存储系统。此页面旨在为读者介绍关于Druid存储数据的高级概述，以及Druid集群的架构。">
    <link rel="icon" href="/imgs/favicon.png">
    
    <link rel="preload" href="/assets/css/0.styles.4ab36692.css" as="style"><link rel="preload" href="/assets/js/app.7684bae7.js" as="script"><link rel="preload" href="/assets/js/2.5dfb5464.js" as="script"><link rel="prefetch" href="/assets/js/10.c6568e35.js"><link rel="prefetch" href="/assets/js/11.8085fb6b.js"><link rel="prefetch" href="/assets/js/3.fdd76a05.js"><link rel="prefetch" href="/assets/js/4.b92890f1.js"><link rel="prefetch" href="/assets/js/5.a9510b1b.js"><link rel="prefetch" href="/assets/js/6.84f350a0.js"><link rel="prefetch" href="/assets/js/7.bf4683c9.js"><link rel="prefetch" href="/assets/js/8.af120a1b.js"><link rel="prefetch" href="/assets/js/9.2937fc3e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4ab36692.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">druid 中文网</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="http://druid.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/apache/incubator-druid" target="_blank" rel="noopener noreferrer" class="nav-link external">
  源码
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="http://druid.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/apache/incubator-druid" target="_blank" rel="noopener noreferrer" class="nav-link external">
  源码
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/#数据" class="sidebar-link">数据</a></li><li class="sidebar-sub-header"><a href="/#汇总" class="sidebar-link">汇总</a></li><li class="sidebar-sub-header"><a href="/#分片数据" class="sidebar-link">分片数据</a></li><li class="sidebar-sub-header"><a href="/#索引数据" class="sidebar-link">索引数据</a></li><li class="sidebar-sub-header"><a href="/#记载数据" class="sidebar-link">记载数据</a></li><li class="sidebar-sub-header"><a href="/#查询数据" class="sidebar-link">查询数据</a></li><li class="sidebar-sub-header"><a href="/#集群" class="sidebar-link">集群</a></li><li class="sidebar-sub-header"><a href="/#外部依赖" class="sidebar-link">外部依赖</a></li><li class="sidebar-sub-header"><a href="/#高可用性" class="sidebar-link">高可用性</a></li></ul></li><li><a href="/架构.html" class="active sidebar-link">架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/架构.html#系统架构" class="sidebar-link">系统架构</a></li><li class="sidebar-sub-header"><a href="/架构.html#segments" class="sidebar-link">Segments</a></li><li class="sidebar-sub-header"><a href="/架构.html#历史节点" class="sidebar-link">历史节点</a></li><li class="sidebar-sub-header"><a href="/架构.html#索引服务" class="sidebar-link">索引服务</a></li><li class="sidebar-sub-header"><a href="/架构.html#实时节点" class="sidebar-link">实时节点</a></li></ul></li><li><a href="/快速开始.html" class="sidebar-link">快速开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/快速开始.html#前提条件需要：" class="sidebar-link">前提条件需要：</a></li><li class="sidebar-sub-header"><a href="/快速开始.html#入门" class="sidebar-link">入门</a></li><li class="sidebar-sub-header"><a href="/快速开始.html#启动zookeeper" class="sidebar-link">启动zookeeper</a></li><li class="sidebar-sub-header"><a href="/快速开始.html#启动druid服务" class="sidebar-link">启动Druid服务</a></li><li class="sidebar-sub-header"><a href="/快速开始.html#数据查询" class="sidebar-link">数据查询</a></li></ul></li><li><a href="/加载数据.html" class="sidebar-link">加载数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/加载数据.html#选择提取方法" class="sidebar-link">选择提取方法</a></li><li class="sidebar-sub-header"><a href="/加载数据.html#入门" class="sidebar-link">入门</a></li><li class="sidebar-sub-header"><a href="/加载数据.html#批处理、流式混合模式" class="sidebar-link">批处理、流式混合模式</a></li></ul></li><li><a href="/从文件加载数据.html" class="sidebar-link">从文件加载数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/从文件加载数据.html#入门" class="sidebar-link">入门</a></li><li class="sidebar-sub-header"><a href="/从文件加载数据.html#编写提取规范" class="sidebar-link">编写提取规范</a></li><li class="sidebar-sub-header"><a href="/从文件加载数据.html#运行任务" class="sidebar-link">运行任务</a></li><li class="sidebar-sub-header"><a href="/从文件加载数据.html#数据查询" class="sidebar-link">数据查询</a></li></ul></li><li><a href="/从流数据加载数据.html" class="sidebar-link">从流数据加载数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/从流数据加载数据.html#入门" class="sidebar-link">入门</a></li><li class="sidebar-sub-header"><a href="/从流数据加载数据.html#编写数据提取规范" class="sidebar-link">编写数据提取规范</a></li><li class="sidebar-sub-header"><a href="/从流数据加载数据.html#重启服务" class="sidebar-link">重启服务</a></li><li class="sidebar-sub-header"><a href="/从流数据加载数据.html#发送数据" class="sidebar-link">发送数据</a></li><li class="sidebar-sub-header"><a href="/从流数据加载数据.html#数据查询" class="sidebar-link">数据查询</a></li></ul></li><li><a href="/从kafka加载数据.html" class="sidebar-link">从kafka加载数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/从kafka加载数据.html#入门" class="sidebar-link">入门</a></li><li class="sidebar-sub-header"><a href="/从kafka加载数据.html#启动kafka" class="sidebar-link">启动kafka</a></li><li class="sidebar-sub-header"><a href="/从kafka加载数据.html#发送示例数据" class="sidebar-link">发送示例数据</a></li><li class="sidebar-sub-header"><a href="/从kafka加载数据.html#数据查询" class="sidebar-link">数据查询</a></li></ul></li><li><a href="/集群.html" class="sidebar-link">集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/集群.html#硬件要求" class="sidebar-link">硬件要求</a></li><li class="sidebar-sub-header"><a href="/集群.html#操作系统" class="sidebar-link">操作系统</a></li><li class="sidebar-sub-header"><a href="/集群.html#下载集群" class="sidebar-link">下载集群</a></li><li class="sidebar-sub-header"><a href="/集群.html#配置deep-storage" class="sidebar-link">配置deep storage</a></li><li class="sidebar-sub-header"><a href="/集群.html#配置tranquility服务器-可选" class="sidebar-link">配置Tranquility服务器 (可选)</a></li><li class="sidebar-sub-header"><a href="/集群.html#配置tranquility-kafka-可选" class="sidebar-link">配置Tranquility Kafka (可选)</a></li><li class="sidebar-sub-header"><a href="/集群.html#配置hadoop-可选" class="sidebar-link">配置Hadoop (可选)</a></li><li class="sidebar-sub-header"><a href="/集群.html#配置druid-coordination" class="sidebar-link">配置Druid coordination</a></li><li class="sidebar-sub-header"><a href="/集群.html#调整服务查询druid进程" class="sidebar-link">调整服务查询Druid进程</a></li><li class="sidebar-sub-header"><a href="/集群.html#调整druid-brokers" class="sidebar-link">调整Druid Brokers</a></li><li class="sidebar-sub-header"><a href="/集群.html#端口开通" class="sidebar-link">端口开通</a></li><li class="sidebar-sub-header"><a href="/集群.html#启动coordinator-overlord-zookeeper-metadata-store" class="sidebar-link">启动Coordinator, Overlord, Zookeeper,  metadata store</a></li><li class="sidebar-sub-header"><a href="/集群.html#启动historicals和middlemanagers" class="sidebar-link">启动Historicals和MiddleManagers</a></li><li class="sidebar-sub-header"><a href="/集群.html#启动druid-broker" class="sidebar-link">启动Druid Broker</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="架构"><a href="#架构" aria-hidden="true" class="header-anchor">#</a> 架构</h1> <h2 id="系统架构"><a href="#系统架构" aria-hidden="true" class="header-anchor">#</a> 系统架构</h2> <p>Druid是一组系统，按照职责分成不同的角色。目前存在五种节点类型：</p> <ul><li><strong>Historical</strong>： 历史节点的职责主要是对历史的数据进行存储和查询，历史节点从Deep Storage下载Segment，然后响应Broker对于Segment的查询将查询结果返回给Broker节点，它们通过Zookeeper来声明自己存储的节点，同时也通过zookeeper来监听加载或删除Segment的信号。
Coordinator：协调节点监测一组历史节点来保证数据的可用和冗余。协调节点读取元数据存储来确定哪些Segment需要load到集群中，通过zk来感知Historical节点的存在，通过在Zookeeper上创建entry来和Historical节点通信来告诉他们加载或者删除Segment</li> <li><strong>Broker</strong>：节点接收外部客户端的查询，并且将查询路由到历史节点和实时节点。当Broker收到返回的结果的时候，它将结果merge起来然后返回给调用者。Broker通过Zook来感知实时节点和历史节点的存在。
Indexing Service: 索引服务是一些worker用来从实时获取数据或者批量插入数据。</li> <li><strong>Realtime</strong>：获取实时数据</li></ul> <p>下面这张图片展示了一次查询数据在整个架构中的流向
<img src="/assets/img/1.819eca8a.png" alt="Druid数据流向"> <center>Druid数据流向</center><br></p> <p>除了上述五个节点，Druid还有三个外部依赖：</p> <ul><li>Zookeeper集群</li> <li>元数据存储实例：Mysql</li> <li>Deep Storage：HDFS</li></ul> <h2 id="segments"><a href="#segments" aria-hidden="true" class="header-anchor">#</a> Segments</h2> <p>Druid 把它的索引存储到一个Segment文件中，Segment文件是通过时间来分割的。
对于摄入到Druid的数据的列，主要分三种类型，时间列，指标列和维度列。如下图
<img src="/assets/img/2.f43f41c6.png" alt="示例数据"> <center>示例数据</center><br>
对于时间列和指标列处理比较简单，直接用LZ4压缩存起来就ok，一旦查询知道去找哪几行，只需要将它们解压，然后用相应的操作符来操作它们就可以了。维度列就没那么简单了，因为它们需要被过滤和聚合，因此每个维度需要下面三个数据结构。</p> <ol><li>一个map，Key是维度的值，值是一个整型的id</li> <li>一个存储列的值得列表，用1中的map编码的list</li> <li>对于列中的每个值对应一个bitmap，这个bitmap用来指示哪些行包含这个个值。</li></ol> <p>对于上图的Page列，它的存储是这样的</p> <div class="language- extra-class"><pre class="language-text"><code>1: 字典
{
    &quot;Justin BIeber&quot;: 0,
    &quot;Ke$ha&quot;:         1
}

2. 值的列表
[0, 0, 1, 1]

3. bitMap
value=&quot;Justin Bieber&quot;: [1, 1, 0, 0]
value=&quot;Ke$ha&quot;:         [0, 0, 1, 1]
</code></pre></div><h2 id="历史节点"><a href="#历史节点" aria-hidden="true" class="header-anchor">#</a> 历史节点</h2> <p>每个历史节点维持一个和Zookeeper的长连接监测一组path来获取新的Segment信息。历史节点互相不进行通信，他们依靠zk来等待协调节点来协调。
协调节点负责把新的Segment分发给历史节点，协调节点通过在zk的指定路径下创建一个entry来向历史节点做分发。
当历史节点发现一个新的entry出现在path中，它首先会检查本地文件缓存看有有没Segment信息，如果没有Segment信息，历史节点会从zk上下载新的Segment的元信息。Segment的元信息包括Segment存在Deep Storage的位置和如何解压和处理Segment。一旦一个历史节点完成对一个Segment的处理，这个历史节点会在zk上的一个路径声明对这个Segment提供查询服务，此刻这个Segment就可以查询了。
查询节点
Broker节点负责将查询路由到历史节点和实时节点，Broker节点通过zk来知道哪些Segment存在哪个节点上。Broker也会把查询的结果进行Merge
大多数Druid查询包含一个区间对象，这个对象用来指定查询所要查的区间段。Druid的Segment也通过时间段进行分割散落在整个集群中。假设有一个简单的数据源，这个数据源有七个Segment，每个Segment包含一周中的某一天的数据。任何一个时间范围超过一天的查询都会落到不止一个Segment上。这些Segment可能分布在集群中不同的节点上。因此这种查询就会涉及到多个节点。
为了确定发送到哪个节点上，Broker会从Historial和RealTime的节点来获取他们提供查询的Segment的信息，然后构建一个时间轴，当收到特定的时间区间的查询时，Broker通过时间轴来选择节点。
Broker节点会维护一个LRU缓存，缓存存着每个Segment的结果，缓存可以是一个本地的缓存或者多个节点共用的外部的缓存如 memcached。当Broker收到查询时候，它首先将查询映射成一堆Segment的查询，其中的一个子集的结果可能已经存在缓存中，他们可以直接从缓存中拉出来，那些没在缓存中的将被发送到相应节点。
协调节点
协调节点负责Segment的管理和分发，协调节点指挥历史节点来加载或者删除Segment，以及Segment的冗余和平衡Segment。协调节点会周期性的进行扫描，每次扫描会根据集群当前的状态来决定进一步的动作。和历史节点和Broker一样，协调节点通过zk来获取Segment信息，同时协调节点还通过数据库来获取可用的Segment信息和规则。在一个Segment提供查询之前，可用的历史节点会按照容量去排序，容量最小的具有最高的优先级，协调节点就会让它去加载这个Segment然后提供服务。
清理Segment，Druid会将集群中的Segment和数据库中的Segment进行对比，如果集群有的的数据库中没有的会被清理掉。同事那些老的被新的替换的Segment也会被清理掉。
Segment可用性, 历史节点可能因为某种原因不可用，协调节点会发现节点不可用了，会将这个节点上的Segment转移到其他的节点。Segment不会立即被转移，如果在配置的时间段内节点恢复了，历史节点会从本地缓存加载Segment。恢复服务
Segment负载均衡，协调节点会找到Segment最多的节点和Segment最少的节点，当他们的比例超过一个设定的值的时候，协调节点会从Segment最多的节点转移到Segment最少的节点。</p> <h2 id="索引服务"><a href="#索引服务" aria-hidden="true" class="header-anchor">#</a> 索引服务</h2> <p>索引服务是一个高可用的，分布式的服务来运行索引相关的Task。索引服务会创建或者销毁Segment。索引服务是一个Master/Slave架构。索引服务是三个组件的集合</p> <ul><li>peon组件用来跑索引任务。</li> <li>Middle Manager组件用来管理peons</li> <li>Overlord向MiddleManager分发任务。</li></ul> <p>索引服务</p> <p><img src="/assets/img/3.8074b72e.png" alt="索引服务"> <center>索引服务</center><br></p> <p>Overlord节点负责接受任务，协调任务分发，创建锁，和返回状态给调用者。Overlord节点可以以本地模式或者远程模式运行。本地模式会直接创建Peon，远程模式会通过Middle Manager创建任务。</p> <h2 id="实时节点"><a href="#实时节点" aria-hidden="true" class="header-anchor">#</a> 实时节点</h2> <p>实时节点提供实时索引服务，通过实时节点索引的数据立即可查。实时节点会周期性的构建Segment，并且把这些Segment推到历史节点并修改元数据。
<img src="/assets/img/4.77aa2ac3.png" alt="实时节点"> <center>实时节点</center><br></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.7684bae7.js" defer></script><script src="/assets/js/2.5dfb5464.js" defer></script>
  </body>
</html>
